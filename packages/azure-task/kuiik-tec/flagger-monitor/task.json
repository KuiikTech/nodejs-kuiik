{
  "$schema": "https://raw.githubusercontent.com/Microsoft/azure-pipelines-task-lib/master/tasks.schema.json",
  "id": "96797BCA-BF46-4C2D-A1DE-9CB1654181B9",
  "name": "flagger-canary-monitor",
  "friendlyName": "Flagger Canary Monitor",
  "description": "Custom Azure DevOps task for monitoring Flagger canaries",
  "helpUrl": "https://github.com/juparog/azure-task-for-flagger/blob/master/README.md",
  "helpMarkDown": "[Learn more about this task](https://go.microsoft.com/fwlink/?linkid=851275) or [see the Flagger documentation](https://flagger.app/)",
  "category": "Utility",
  "icons": {
    "default": "img/icon-flagger.png"
  },
  "visibility": [
    "Release"
  ],
  "author": "kuiik Tec (https://github.com/kuiiktech)",
  "version": {
    "Major": 2,
    "Minor": 0,
    "Patch": 4
  },
  "demands": [],
  "releaseNotes": "What's new in Version 0.0.1:<br/>&nbsp;First version of the task, if you find problems please open an issue at: https://github.com/kuiiktech/nodejs-kuiik//issues<br/>&nbsp;.",
  "groups": [
    {
      "name": "kubernetesCluster",
      "displayName": "Kubernetes Cluster",
      "isExpanded": true
    },
    {
      "name": "flaggerCanaryMonitoring",
      "displayName": "Flagger Canary Monitoring",
      "isExpanded": true
    },
    {
      "name": "advancedFlaggerCanaryMonitpring",
      "displayName": "Advanced Flagger Canary Monitoring",
      "isExpanded": false
    },
    {
      "name": "advancedKubernetesCluster",
      "displayName": "Advanced Kubernetes Cluster",
      "isExpanded": false
    },
    {
      "name": "output",
      "displayName": "Output",
      "isExpanded": false
    },
    {
      "name": "output",
      "displayName": "Output",
      "isExpanded": false
    }
  ],
  "inputs": [
    {
      "name": "connectionType",
      "type": "pickList",
      "label": "Service connection type",
      "defaultValue": "Kubernetes Service Connection",
      "required": true,
      "options": {
        "Azure Resource Manager": "Azure Resource Manager",
        "Kubernetes Service Connection": "Kubernetes Service Connection",
        "None": "None"
      },
      "groupName": "kubernetesCluster",
      "helpMarkDown": "Select a service connection type."
    },
    {
      "name": "kubernetesServiceEndpoint",
      "type": "connectedService:kubernetes",
      "label": "Kubernetes service connection",
      "visibleRule": "connectionType = Kubernetes Service Connection",
      "helpMarkDown": "Select a Kubernetes service connection.",
      "groupName": "kubernetesCluster",
      "required": true
    },
    {
      "name": "azureSubscriptionEndpoint",
      "type": "connectedService:AzureRM",
      "label": "Azure subscription",
      "helpMarkDown": "Select the Azure Resource Manager subscription, which contains Azure Container Registry.Note: To configure new service connection, select the Azure subscription from the list and click 'Authorize'. If your subscription is not listed or if you want to use an existing Service Principal, you can setup an Azure service connection using 'Add' or 'Manage' button.",
      "visibleRule": "connectionType = Azure Resource Manager",
      "defaultValue": "",
      "groupName": "kubernetesCluster",
      "required": true
    },
    {
      "name": "azureResourceGroup",
      "label": "Resource group",
      "type": "pickList",
      "helpMarkDown": "Select an Azure resource group.",
      "visibleRule": "connectionType = Azure Resource Manager",
      "defaultValue": "",
      "required": true,
      "groupName": "kubernetesCluster",
      "properties": {
        "EditableOptions": "True"
      }
    },
    {
      "name": "kubernetesCluster",
      "label": "Kubernetes cluster",
      "type": "pickList",
      "helpMarkDown": "Select an Azure managed cluster.",
      "visibleRule": "connectionType = Azure Resource Manager",
      "defaultValue": "",
      "required": true,
      "groupName": "kubernetesCluster",
      "properties": {
        "EditableOptions": "True"
      }
    },
    {
      "name": "useClusterAdmin",
      "type": "boolean",
      "label": "Use cluster admin credentials",
      "defaultValue": "false",
      "visibleRule": "connectionType = Azure Resource Manager",
      "groupName": "kubernetesCluster",
      "helpMarkDown": "Use cluster administrator credentials instead of default cluster user credentials."
    },
    {
      "name": "namespace",
      "type": "string",
      "label": "Namespace",
      "required": false,
      "defaultValue": "",
      "groupName": "kubernetesCluster",
      "helpMarkDown": "Set the namespace for the kubectl command by using the â€“namespace flag. If the namespace is not provided, the commands will run in the default namespace."
    },
    {
      "name": "canaryNameInput",
      "type": "multiLine",
      "properties": {
        "resizable": true,
        "rows": "5",
        "maxLength": "5000"
      },
      "label": "Canary Resource Names",
      "required": true,
      "defaultValue": "",
      "groupName": "flaggerCanaryMonitoring",
      "helpMarkDown": "Specify the names of the Flagger Canary resources (comma or newline-separated)."
    },
    {
      "name": "arguments",
      "type": "string",
      "label": "Arguments",
      "helpMarkDown": "Kubectl command options.",
      "groupName": "flaggerCanaryMonitoring"
    },
    {
      "name": "initialValueInput",
      "type": "int",
      "label": "Initial Value to Wait (seconds)",
      "defaultValue": "60",
      "required": true,
      "groupName": "advancedFlaggerCanaryMonitpring",
      "helpMarkDown": "Specify the initial time (in seconds, up to 300) to wait before starting monitoring."
    },
    {
      "name": "frequencyInput",
      "type": "int",
      "label": "Monitoring Frequency (seconds)",
      "defaultValue": "30",
      "required": true,
      "groupName": "advancedFlaggerCanaryMonitpring",
      "helpMarkDown": "Specify the frequency (in seconds, up to 60) to check the Canary status."
    },
    {
      "name": "timeoutInput",
      "type": "int",
      "label": "Timeout Values (seconds)",
      "defaultValue": "300",
      "required": true,
      "groupName": "advadvancedFlaggerCanaryMonitpringanced",
      "helpMarkDown": "Specify the maximum time (in seconds, up to 900) to wait for the Canary status to change."
    },
    {
      "name": "cwd",
      "aliases": [
        "workingDirectory"
      ],
      "type": "filePath",
      "label": "Working directory",
      "defaultValue": "$(System.DefaultWorkingDirectory)",
      "helpMarkDown": "Working directory for the Kubectl command.",
      "groupName": "advancedKubernetesCluster"
    }
  ],
  "dataSourceBindings": [
    {
      "target": "azureContainerRegistry",
      "endpointId": "$(azureSubscriptionEndpointForSecrets)",
      "dataSourceName": "AzureRMContainerRegistries",
      "resultTemplate": "{\"Value\":\"{{{properties.loginServer}}}\",\"DisplayValue\":\"{{{name}}}\"}"
    },
    {
      "target": "kubernetesCluster",
      "endpointId": "$(azureSubscriptionEndpoint)",
      "endpointUrl": "{{{endpoint.url}}}/subscriptions/{{{endpoint.subscriptionId}}}/resourceGroups/$(azureResourceGroup)/providers/Microsoft.ContainerService/managedClusters?api-version=2017-08-31",
      "resultSelector": "jsonpath:$.value[*]",
      "resultTemplate": "{{{name}}}"
    },
    {
      "target": "azureResourceGroup",
      "endpointId": "$(azureSubscriptionEndpoint)",
      "endpointUrl": "{{{endpoint.url}}}/subscriptions/{{{endpoint.subscriptionId}}}/providers/Microsoft.ContainerService/managedClusters?api-version=2017-08-31",
      "resultSelector": "jsonpath:$.value[*]",
      "resultTemplate": "{{{ #extractResource id resourcegroups}}}"
    }
  ],
  "outputVariables": [
    {
      "name": "FlaggerCanaryMonitorOutput",
      "description": "Stores the output of the flagger canary monitor task"
    }
  ],
  "prejobexecution": {
    "Node": {
      "target": "src/downloadsecurefiles.js"
    }
  },
  "execution": {
    "Node": {
      "target": "src/flagger.js"
    }
  },
  "postjobexecution": {
    "Node": {
      "target": "src/deletesecurefiles.js"
    }
  },
  "messages": {
    "KubeConfigFilePath": "Kubeconfig file path: %s",
    "KubeConfigFilePathWithConectionnTypeNoNe": "KUBECONFIG kube configuration file path must be set when connectionType is None.",
    "KubeloginFailed": "Kubelogin authentication failed. Exception: %s",
    "KubernetesClusterResourceGroup": "Kubernetes cluster %s, resource group %s.",
    "KubernetesServiceConnectionNotFound": "Kubernetes service connection details not found.",
    "SkipDeleteSecureFiles": "TLS not enabled in the Task. Skipping delete of certificates.",
    "SkipDownloadSecureFiles": "TLS not enabled in the Task. Skipping download of certificates."
  }
}